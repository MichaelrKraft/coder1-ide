<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Component Preview Sandbox</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { 
            margin: 0; 
            padding: 20px; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", sans-serif; 
            background: #ffffff; 
            color: #24292f; 
        }
        #root { 
            width: 100%; 
            height: 100%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 200px; 
        }
        .loading { 
            color: #656d76; 
            font-style: italic; 
        }
        .error { 
            color: #d1242f; 
            background: #fff5f5; 
            padding: 16px; 
            border-radius: 6px; 
            border: 1px solid #fd8c8c; 
        }
    </style>
</head>
<body>
    <div id="root"><div class="loading">Loading component...</div></div>
    <script>
        console.log('Sandbox: Script started');
        
        // Send ready message
        window.parent.postMessage({ type: 'SANDBOX_READY' }, '*');
        console.log('Sandbox: Sent SANDBOX_READY');
        
        // Listen for messages
        window.addEventListener('message', function(event) {
            console.log('Sandbox: Received message:', event.data);
            
            if (event.data.type === 'TEST_RENDER') {
                document.getElementById('root').innerHTML = 
                    '<div style="padding: 20px; background: #4CAF50; color: white; border-radius: 8px;">âœ… Sandbox is working!</div>';
                window.parent.postMessage({ type: 'TEST_RENDER_SUCCESS' }, '*');
            }
            
            if (event.data.type === 'RENDER_COMPONENT') {
                console.log('Sandbox: Rendering component:', event.data.component);
                try {
                    const component = event.data.component;
                    const { code, props = {}, name } = component;
                    
                    // Remove import statements and replace with global references
                    let processedCode = code;
                    
                    // Remove React imports and replace with global React
                    processedCode = processedCode.replace(/import\s+React(?:\s*,\s*\{[^}]*\})?\s+from\s+['"][^'"]*['"];?\s*/g, '');
                    processedCode = processedCode.replace(/import\s+\{([^}]+)\}\s+from\s+['"]react['"];?\s*/g, (match, hooks) => {
                        // Extract hook names and make them available
                        const hookNames = hooks.split(',').map(h => h.trim());
                        return `// Hooks available: ${hookNames.join(', ')}`;
                    });
                    
                    // Remove other import statements for now
                    processedCode = processedCode.replace(/import\s+.*?from\s+['"][^'"]*['"];?\s*/g, '');
                    
                    // Handle export statements - remove them and capture the component name
                    let componentName = name;
                    processedCode = processedCode.replace(/export\s+default\s+(\w+);?\s*/g, (match, compName) => {
                        componentName = compName;
                        return `window.ExportedComponent = ${compName};`;
                    });
                    
                    // Handle named exports
                    processedCode = processedCode.replace(/export\s+\{([^}]+)\};?\s*/g, '');
                    processedCode = processedCode.replace(/export\s+(const|function|class)\s+(\w+)/g, '$1 $2');
                    
                    console.log('Sandbox: Processed code (imports removed):', processedCode);
                    
                    // Transform with Babel
                    const transformed = Babel.transform(processedCode, {
                        presets: ['react']
                    }).code;
                    
                    console.log('Sandbox: Transformed code:', transformed);
                    
                    // Extract React hooks for the component
                    const { useState, useEffect, useMemo, useCallback } = React;
                    
                    // Create component - handle both default export and named export
                    const ComponentFactory = new Function(
                        'React', 'useState', 'useEffect', 'useMemo', 'useCallback',
                        transformed + `
                        // Try to find the component in different ways
                        if (typeof window.ExportedComponent !== 'undefined') return window.ExportedComponent;
                        if (typeof ${componentName} !== 'undefined') return ${componentName};
                        if (typeof TestComponent !== 'undefined') return TestComponent;
                        if (typeof Component !== 'undefined') return Component;
                        throw new Error('Could not find component to render. Component name: ${componentName}');
                        `
                    );
                    const Component = ComponentFactory(React, useState, useEffect, useMemo, useCallback);
                    
                    // Render
                    const root = ReactDOM.createRoot(document.getElementById('root'));
                    root.render(React.createElement(Component, props));
                    
                    console.log('Sandbox: Component rendered successfully');
                    window.parent.postMessage({ type: 'COMPONENT_RENDERED' }, '*');
                } catch (error) {
                    console.error('Sandbox: Render error:', error);
                    document.getElementById('root').innerHTML = 
                        '<div class="error"><h4>Error</h4><p>' + error.message + '</p></div>';
                    window.parent.postMessage({ type: 'SANDBOX_ERROR', error: error.message }, '*');
                }
            }
        });
    </script>
</body>
</html>